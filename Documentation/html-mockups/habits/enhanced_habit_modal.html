        function collectHabitData() {
            const nameInput = document.querySelector('input[placeholder="What habit do you want to build?"]');
            const descriptionTextarea = document.querySelector('textarea[placeholder*="important"]');
            const targetInput = document.getElementById('targetInput');
            const customInput = document.getElementById('customInput');
            const customSelect = document.getElementById('customSelect');
            const goalSelect = document.getElementById('goalSelect');
            const startDateInput = document.getElementById('startDate');
            const habitTimeInput = document.getElementById('habitTime');
            const reminderTimeSelect = document.getElementById('reminderTime');
            
            const habitData = {
                name: nameInput.value.trim(),
                description: descriptionTextarea.value.trim() || null,
                icon: selectedIcon,
                color: selectedColor,
                measurementType: selectedMeasurementType,
                frequency: selectedFrequency,
                goalId: goalLinkEnabled ? goalSelect.value || null : null,
                calendarIntegration: calendarIntegrationEnabled,
                createdAt: new Date().toISOString()
            };
            
            // Add target amount for non-simple measurement types
            if (selectedMeasurementType !== 'simple') {
                habitData.targetAmount = parseInt(targetInput.value);
                habitData.targetUnit = document.getElementById('targetUnit').textContent;
            }
            
            // Add frequency-specific data
            if (selectedFrequency === 'weekly') {
                habitData.selectedDays = selectedDays;
            } else if (selectedFrequency === 'custom') {
                habitData.customFrequency = {
                    times: parseInt(customInput.value),
                    period: customSelect.value
                };
            }
            
            // Add scheduling data
            if (startDateInput.value) {
                habitData.startDate = startDateInput.value;
            }
            
            if (habitTimeInput.value) {
                habitData.scheduledTime = habitTimeInput.value;
            }
            
            if (reminderTimeSelect.value) {
                habitData.reminderMinutes = parseInt(reminderTimeSelect.value);
            }
            
            // Generate calendar events data for integration
            if (calendarIntegrationEnabled) {
                habitData.calendarEvents = generateCalendarEvents(habitData);
            }
            
            return habitData;
        }

        function generateCalendarEvents(habitData) {
            const events = [];
            const startDate = new Date(habitData.startDate || new Date());
            const scheduledTime = habitData.scheduledTime || '09:00';
            
            // Generate events based on frequency
            if (habitData.frequency === 'daily') {
                // For daily habits, we'll generate events for the next 30 days as an example
                for (let i = 0; i < 30; i++) {
                    const eventDate = new Date(startDate);
                    eventDate.setDate(startDate.getDate() + i);
                    
                    events.push(createCalendarEvent(habitData, eventDate, scheduledTime));
                }
            } else if (habitData.frequency === 'weekly' && habitData.selectedDays) {
                // For weekly habits, generate events for selected days
                const dayMap = {
                    'mon': 1, 'tue': 2, 'wed': 3, 'thu': 4, 
                    'fri': 5, 'sat': 6, 'sun': 0
                };
                
                // Generate for next 8 weeks
                for (let week = 0; week < 8; week++) {
                    habitData.selectedDays.forEach(day => {
                        const eventDate = new Date(startDate);
                        const dayOfWeek = dayMap[day];
                        const daysToAdd = (dayOfWeek - eventDate.getDay() + 7) % 7 + (week * 7);
                        eventDate.setDate(startDate.getDate() + daysToAdd);
                        
                        events.push(createCalendarEvent(habitData, eventDate, scheduledTime));
                    });
                }
            }
            
            return events;
        }

        function createCalendarEvent(habitData, date, time) {
            const [hours, minutes] = time.split(':').map(Number);
            const startDateTime = new Date(date);
            startDateTime.setHours(hours, minutes, 0, 0);
            
            const endDateTime = new Date(startDateTime);
            if (habitData.duration && habitData.duration.totalMinutes) {
                endDateTime.setMinutes(endDateTime.getMinutes() + habitData.duration.totalMinutes);
            } else {
                endDateTime.setMinutes(endDateTime.getMinutes() + 30); // Default 30 minutes
            }
            
        function createCalendarEvent(habitData, date, time) {
            const [hours, minutes] = time.split(':').map(Number);
            const startDateTime = new Date(date);
            startDateTime.setHours(hours, minutes, 0, 0);
            
            const endDateTime = new Date(startDateTime);
            // Default 30-minute duration for simplicity
            endDateTime.setMinutes(endDateTime.getMinutes() + 30);
            
            return {
                title: habitData.name,
                start: startDateTime.toISOString(),
                end: endDateTime.toISOString(),
                description: habitData.description || `Complete habit: ${habitData.name}`,
                type: 'habit',
                habitId: null, // Will be set after habit is created
                reminder: habitData.reminderMinutes || null,
                icon: habitData.icon,
                color: habitData.color
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today as default start date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            
            // Add input listeners for validation
            const nameInput = document.querySelector('input[placeholder="What habit do you want to build?"]');
            const targetInput = document.getElementById('targetInput');
            const customInput = document.getElementById('customInput');
            const timeInput = document.getElementById('habitTime');
            
            nameInput.addEventListener('input', () => {
                validateForm();
                updateCalendarPreview();
            });
            targetInput.addEventListener('input', validateForm);
            customInput.addEventListener('input', validateForm);
            timeInput.addEventListener('change', updateCalendarPreview);
            
            // Initial validation and preview update
            validateForm();
            updateCalendarPreview();
        });<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Habit Creation Modal - Project Kage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #1a1a1a;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideUp 0.3s ease-out;
            color: white;
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 24px 16px;
            border-bottom: 1px solid #333;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #333;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #ccc;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #444;
            color: white;
        }

        .modal-body {
            padding: 0 24px 24px;
            max-height: calc(90vh - 160px);
            overflow-y: auto;
        }

        /* Icon Selection */
        .icon-section {
            margin-bottom: 24px;
            text-align: center;
        }

        .icon-display {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            background: #333;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
        }

        .icon-display.selected {
            border-color: #FF7101;
            background: #FF7101;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            background: #222;
            border-radius: 12px;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .icon-option:hover {
            background: #444;
            transform: scale(1.1);
        }

        .icon-option.selected {
            border-color: #FF7101;
            background: #FF7101;
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 24px;
        }

        .section-label {
            font-size: 14px;
            font-weight: 600;
            color: #ccc;
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #333;
            border-radius: 12px;
            font-size: 16px;
            color: white;
            background: #222;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #FF7101;
            box-shadow: 0 0 0 3px rgba(255, 113, 1, 0.1);
        }

        .form-input::placeholder {
            color: #666;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Color Selection */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
        }

        .color-option {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 2px #FF7101;
        }

        .color-option.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        /* Measurement Types */
        .measurement-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .measurement-type {
            padding: 16px;
            border: 2px solid #333;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #222;
            text-align: center;
        }

        .measurement-type:hover {
            border-color: #555;
            background: #2a2a2a;
        }

        .measurement-type.selected {
            border-color: #FF7101;
            background: rgba(255, 113, 1, 0.1);
        }

        .measurement-type-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .measurement-type-name {
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .measurement-type-desc {
            font-size: 12px;
            color: #999;
        }

        .measurement-type.selected .measurement-type-name {
            color: #FF7101;
        }

        /* Target Amount Section */
        .target-section {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: #222;
            border-radius: 12px;
            border: 1px solid #333;
        }

        .target-section.active {
            display: block;
        }

        .target-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }

        .target-input {
            padding: 8px 12px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            color: white;
            font-size: 16px;
        }

        .target-input:focus {
            outline: none;
            border-color: #FF7101;
        }

        .target-unit {
            padding: 8px 12px;
            background: #333;
            border-radius: 8px;
            font-size: 14px;
            color: #ccc;
            min-width: 80px;
            text-align: center;
        }

        /* Frequency Selection */
        .frequency-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .frequency-option {
            padding: 12px;
            border: 2px solid #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #222;
            text-align: center;
        }

        .frequency-option:hover {
            border-color: #555;
        }

        .frequency-option.selected {
            border-color: #FF7101;
            background: rgba(255, 113, 1, 0.1);
            color: #FF7101;
        }

        .frequency-option-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .frequency-option-desc {
            font-size: 11px;
            color: #999;
        }

        /* Weekly Days Selection */
        .weekly-days {
            display: none;
            margin-top: 12px;
        }

        .weekly-days.active {
            display: block;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-option {
            padding: 8px 4px;
            border: 2px solid #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #222;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
        }

        .day-option:hover {
            border-color: #555;
        }

        .day-option.selected {
            border-color: #FF7101;
            background: #FF7101;
            color: white;
        }

        /* Custom Frequency */
        .custom-frequency {
            display: none;
            margin-top: 12px;
        }

        .custom-frequency.active {
            display: block;
        }

        .custom-container {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px;
            align-items: center;
        }

        .custom-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            color: white;
            text-align: center;
        }

        .custom-input:focus {
            outline: none;
            border-color: #FF7101;
        }

        .custom-select {
            padding: 8px 12px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            color: white;
        }

        .custom-select:focus {
            outline: none;
            border-color: #FF7101;
        }

        /* Goal Linking */
        .goal-linking {
            margin-bottom: 24px;
        }

        .goal-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .toggle-switch {
            width: 48px;
            height: 24px;
            background: #333;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-switch.active {
            background: #FF7101;
        }

        .toggle-knob {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch.active .toggle-knob {
            left: 26px;
        }

        .goal-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #333;
            border-radius: 8px;
            font-size: 14px;
            background: #222;
            color: white;
        }

        .goal-select:focus {
            outline: none;
            border-color: #FF7101;
        }

        .goal-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .goal-select option {
            background: #222;
            color: white;
        }

        /* Scheduling Options */
        .scheduling-options {
            margin-bottom: 24px;
        }

        .scheduling-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #222;
            border-radius: 12px;
            border: 1px solid #333;
            transition: all 0.2s;
        }

        .scheduling-toggle:hover {
            background: #2a2a2a;
            border-color: #444;
        }

        .scheduling-toggle.expanded {
            background: rgba(255, 113, 1, 0.1);
            border-color: #FF7101;
        }

        .scheduling-toggle-icon {
            font-size: 20px;
        }

        .scheduling-toggle-text {
            font-size: 16px;
            font-weight: 600;
            color: white;
            flex: 1;
        }

        .scheduling-toggle-arrow {
            font-size: 12px;
            color: #ccc;
            transition: transform 0.2s;
        }

        .scheduling-toggle.expanded .scheduling-toggle-arrow {
            transform: rotate(90deg);
        }

        .scheduling-content {
            display: none;
            animation: slideDown 0.3s ease-out;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 12px;
            border: 1px solid #333;
            margin-top: 8px;
        }

        .scheduling-content.expanded {
            display: block;
        }

        .scheduling-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .scheduling-field {
            display: flex;
            flex-direction: column;
        }

        .scheduling-input {
            padding: 10px 12px;
            border: 2px solid #333;
            border-radius: 8px;
            font-size: 14px;
            background: #222;
            color: white;
            transition: all 0.2s;
        }

        .scheduling-input:focus {
            outline: none;
            border-color: #FF7101;
            box-shadow: 0 0 0 2px rgba(255, 113, 1, 0.1);
        }

        .scheduling-input option {
            background: #222;
            color: white;
        }

        .calendar-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
        }

        .calendar-toggle-label {
            font-size: 14px;
            color: #ccc;
        }

        .custom-duration {
            margin-bottom: 20px;
            padding: 16px;
            background: #222;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .custom-duration-container {
            display: grid;
            grid-template-columns: auto auto auto auto;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .custom-duration-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #1a1a1a;
            color: white;
            text-align: center;
            font-size: 14px;
        }

        .custom-duration-input:focus {
            outline: none;
            border-color: #FF7101;
        }

        .duration-label {
            font-size: 14px;
            color: #ccc;
        }

        .calendar-preview {
            background: #222;
            border-radius: 12px;
            border: 1px solid #333;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .calendar-preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #333;
            border-bottom: 1px solid #444;
        }

        .calendar-preview-icon {
            font-size: 16px;
        }

        .calendar-preview-title {
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .calendar-preview-content {
            padding: 16px;
        }

        .calendar-event-preview {
            background: rgba(255, 113, 1, 0.1);
            border: 1px solid rgba(255, 113, 1, 0.3);
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #FF7101;
        }

        .event-time {
            font-size: 12px;
            color: #FF7101;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .event-title {
            font-size: 14px;
            color: white;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .event-frequency {
            font-size: 12px;
            color: #ccc;
        }

        .calendar-preview-note {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(255, 113, 1, 0.05);
            border-top: 1px solid #333;
        }

        .preview-note-icon {
            font-size: 14px;
        }

        .preview-note-text {
            font-size: 12px;
            color: #ccc;
            line-height: 1.4;
        }

        .difficulty-section {
            background: #222;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #333;
        }

        .difficulty-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }

        .difficulty-stars {
            display: flex;
            gap: 4px;
        }

        .star {
            font-size: 20px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star.active {
            color: #FFD700;
        }

        .star:hover {
            color: #FFD700;
            transform: scale(1.1);
        }

        /* Modal Footer */
        .modal-footer {
            padding: 16px 24px 24px;
            border-top: 1px solid #333;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background: #333;
            color: #ccc;
            border: 1px solid #444;
        }

        .btn-secondary:hover {
            background: #444;
            color: white;
        }

        .btn-primary {
            background: #FF7101;
            color: white;
            box-shadow: 0 2px 8px rgba(255, 113, 1, 0.3);
        }

        .btn-primary:hover {
            background: #e55a00;
            box-shadow: 0 4px 12px rgba(255, 113, 1, 0.4);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Responsive */
        @media (max-width: 540px) {
            .modal {
                margin: 16px;
                max-width: none;
                border-radius: 16px;
            }

            .modal-header {
                padding: 16px 20px 12px;
            }

            .modal-body {
                padding: 0 20px 20px;
            }

            .modal-footer {
                padding: 12px 20px 20px;
                flex-direction: column-reverse;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .measurement-types {
                grid-template-columns: 1fr;
            }

            .frequency-options {
                grid-template-columns: 1fr;
            }

            .color-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            .icon-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .advanced-content.expanded {
                grid-template-columns: 1fr;
            }

            .scheduling-grid {
                grid-template-columns: 1fr;
            }

            .custom-duration-container {
                grid-template-columns: auto auto auto auto;
                gap: 6px;
            }

            .difficulty-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="modal-overlay">
        <div class="modal">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="modal-title">New Habit</h2>
                <button class="close-btn" onclick="closeModal()">✕</button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Icon Selection -->
                <div class="icon-section">
                    <div class="icon-display" id="selectedIcon" onclick="toggleIconGrid()">
                        🎯
                    </div>
                    <div class="icon-grid" id="iconGrid" style="display: none;">
                        <div class="icon-option" onclick="selectIcon(this, '💪')">💪</div>
                        <div class="icon-option" onclick="selectIcon(this, '🏃')">🏃</div>
                        <div class="icon-option" onclick="selectIcon(this, '💧')">💧</div>
                        <div class="icon-option" onclick="selectIcon(this, '📚')">📚</div>
                        <div class="icon-option" onclick="selectIcon(this, '🧘')">🧘</div>
                        <div class="icon-option" onclick="selectIcon(this, '🥗')">🥗</div>
                        <div class="icon-option" onclick="selectIcon(this, '💰')">💰</div>
                        <div class="icon-option" onclick="selectIcon(this, '🌅')">🌅</div>
                        <div class="icon-option" onclick="selectIcon(this, '📝')">📝</div>
                        <div class="icon-option" onclick="selectIcon(this, '🎨')">🎨</div>
                        <div class="icon-option" onclick="selectIcon(this, '🎵')">🎵</div>
                        <div class="icon-option" onclick="selectIcon(this, '🌱')">🌱</div>
                        <div class="icon-option" onclick="selectIcon(this, '🏠')">🏠</div>
                        <div class="icon-option" onclick="selectIcon(this, '👥')">👥</div>
                        <div class="icon-option" onclick="selectIcon(this, '🎯')">🎯</div>
                        <div class="icon-option" onclick="selectIcon(this, '⚡')">⚡</div>
                        <div class="icon-option" onclick="selectIcon(this, '🔥')">🔥</div>
                        <div class="icon-option" onclick="selectIcon(this, '✨')">✨</div>
                        <div class="icon-option" onclick="selectIcon(this, '🌟')">🌟</div>
                        <div class="icon-option" onclick="selectIcon(this, '🎈')">🎈</div>
                        <div class="icon-option" onclick="selectIcon(this, '🎊')">🎊</div>
                        <div class="icon-option" onclick="selectIcon(this, '🎉')">🎉</div>
                        <div class="icon-option" onclick="selectIcon(this, '🏆')">🏆</div>
                        <div class="icon-option" onclick="selectIcon(this, '💎')">💎</div>
                    </div>
                </div>

                <!-- Name -->
                <div class="form-section">
                    <label class="section-label">Name *</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        placeholder="What habit do you want to build?"
                        maxlength="50"
                        oninput="validateForm()"
                        required
                    >
                </div>

                <!-- Description -->
                <div class="form-section">
                    <label class="section-label">Description (Optional)</label>
                    <textarea 
                        class="form-input form-textarea" 
                        placeholder="Why is this habit important to you?"
                        maxlength="200"
                    ></textarea>
                </div>

                <!-- Color Selection -->
                <div class="form-section">
                    <label class="section-label">Color *</label>
                    <div class="color-grid">
                        <div class="color-option selected" onclick="selectColor(this)" style="background: linear-gradient(135deg, #FF7101, #FF5722);"></div>
                        <div class="color-option" onclick="selectColor(this)" style="background: linear-gradient(135deg, #2196F3, #1976D2);"></div>
                        <div class="color-option" onclick="selectColor(this)" style="background: linear-gradient(135deg, #4CAF50, #388E3C);"></div>
                        <div class="color-option" onclick="selectColor(this)" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);"></div>
                        <div class="color-option" onclick="selectColor(this)" style="background: linear-gradient(135deg, #E91E63, #C2185B);"></div>
                        <div class="color-option" onclick="selectColor(this)" style="background: linear-gradient(135deg, #FFEB3B, #FBC02D);"></div>
                        <div class="color-option" onclick="selectColor(this)" style="background: linear-gradient(135deg, #607D8B, #455A64);"></div>
                    </div>
                </div>

                <!-- Measurement Type -->
                <div class="form-section">
                    <label class="section-label">How should completions be tracked? *</label>
                    <div class="measurement-types">
                        <div class="measurement-type selected" onclick="selectMeasurementType(this, 'simple')">
                            <div class="measurement-type-icon">✅</div>
                            <div class="measurement-type-name">Simple</div>
                            <div class="measurement-type-desc">Yes/No daily</div>
                        </div>
                        <div class="measurement-type" onclick="selectMeasurementType(this, 'count')">
                            <div class="measurement-type-icon">🔢</div>
                            <div class="measurement-type-name">Count</div>
                            <div class="measurement-type-desc">Track number</div>
                        </div>
                        <div class="measurement-type" onclick="selectMeasurementType(this, 'time')">
                            <div class="measurement-type-icon">⏱️</div>
                            <div class="measurement-type-name">Time</div>
                            <div class="measurement-type-desc">Track duration</div>
                        </div>
                        <div class="measurement-type" onclick="selectMeasurementType(this, 'custom')">
                            <div class="measurement-type-icon">📊</div>
                            <div class="measurement-type-name">Custom</div>
                            <div class="measurement-type-desc">Custom units</div>
                        </div>
                    </div>

                    <!-- Target Amount Section -->
                    <div class="target-section" id="targetSection">
                        <label class="section-label">Target Amount *</label>
                        <div class="target-container">
                            <input type="number" class="target-input" id="targetInput" placeholder="0" min="1">
                            <div class="target-unit" id="targetUnit">times</div>
                        </div>
                    </div>
                </div>

                <!-- Frequency -->
                <div class="form-section">
                    <label class="section-label">Frequency *</label>
                    <div class="frequency-options">
                        <div class="frequency-option selected" onclick="selectFrequency(this, 'daily')">
                            <div class="frequency-option-name">Daily</div>
                            <div class="frequency-option-desc">Every day</div>
                        </div>
                        <div class="frequency-option" onclick="selectFrequency(this, 'weekly')">
                            <div class="frequency-option-name">Weekly</div>
                            <div class="frequency-option-desc">Select days</div>
                        </div>
                        <div class="frequency-option" onclick="selectFrequency(this, 'custom')">
                            <div class="frequency-option-name">Custom</div>
                            <div class="frequency-option-desc">X times per period</div>
                        </div>
                    </div>

                    <!-- Weekly Days Selection -->
                    <div class="weekly-days" id="weeklyDays">
                        <label class="section-label">Select Days *</label>
                        <div class="days-grid">
                            <div class="day-option" onclick="toggleDay(this)" data-day="mon">M</div>
                            <div class="day-option" onclick="toggleDay(this)" data-day="tue">T</div>
                            <div class="day-option" onclick="toggleDay(this)" data-day="wed">W</div>
                            <div class="day-option" onclick="toggleDay(this)" data-day="thu">T</div>
                            <div class="day-option" onclick="toggleDay(this)" data-day="fri">F</div>
                            <div class="day-option" onclick="toggleDay(this)" data-day="sat">S</div>
                            <div class="day-option" onclick="toggleDay(this)" data-day="sun">S</div>
                        </div>
                    </div>

                    <!-- Custom Frequency -->
                    <div class="custom-frequency" id="customFrequency">
                        <label class="section-label">Custom Frequency *</label>
                        <div class="custom-container">
                            <input type="number" class="custom-input" id="customInput" placeholder="3" min="1" max="7">
                            <span style="color: #ccc;">times per</span>
                            <select class="custom-select" id="customSelect">
                                <option value="week">week</option>
                                <option value="month">month</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Goal Linking -->
                <div class="goal-linking">
                    <div class="goal-toggle-container">
                        <label class="section-label" style="margin: 0;">Link to Goal?</label>
                        <div class="toggle-switch active" onclick="toggleGoalLink(this)" id="goalToggle">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <select class="goal-select" id="goalSelect">
                        <option value="">Select a goal...</option>
                        <option value="1">🏃 Get Fit & Healthy</option>
                        <option value="2">🚀 Launch Side Project</option>
                        <option value="3">📚 Learn Spanish</option>
                        <option value="4">🧘 Mindfulness Practice</option>
                        <option value="new">+ Create New Goal</option>
                    </select>
                </div>

                <!-- Scheduling -->
                <div class="scheduling-options">
                    <div class="scheduling-toggle" onclick="toggleScheduling(this)">
                        <span class="scheduling-toggle-icon">📅</span>
                        <span class="scheduling-toggle-text">Scheduling</span>
                        <span class="scheduling-toggle-arrow">▶</span>
                    </div>
                    <div class="scheduling-content" id="schedulingContent">
                        <div class="scheduling-grid">
                            <div class="scheduling-field">
                                <label class="section-label">Start Date</label>
                                <input type="date" class="scheduling-input" id="startDate">
                            </div>
                            <div class="scheduling-field">
                                <label class="section-label">Time</label>
                                <input type="time" class="scheduling-input" id="habitTime" value="09:00">
                            </div>
                            <div class="scheduling-field">
                                <label class="section-label">Reminder</label>
                                <select class="scheduling-input" id="reminderTime">
                                    <option value="">No reminder</option>
                                    <option value="0">At time of habit</option>
                                    <option value="5">5 minutes before</option>
                                    <option value="15">15 minutes before</option>
                                    <option value="30">30 minutes before</option>
                                    <option value="60">1 hour before</option>
                                </select>
                            </div>
                            <div class="scheduling-field">
                                <label class="section-label">Calendar Integration</label>
                                <div class="calendar-toggle-container">
                                    <div class="toggle-switch active" onclick="toggleCalendarIntegration(this)" id="calendarToggle">
                                        <div class="toggle-knob"></div>
                                    </div>
                                    <span class="calendar-toggle-label">Add to calendar</span>
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Preview -->
                        <div class="calendar-preview" id="calendarPreview">
                            <div class="calendar-preview-header">
                                <span class="calendar-preview-icon">📅</span>
                                <span class="calendar-preview-title">Calendar Events Preview</span>
                            </div>
                            <div class="calendar-preview-content" id="calendarPreviewContent">
                                <div class="calendar-event-preview">
                                    <div class="event-time">9:00 AM</div>
                                    <div class="event-title" id="previewEventTitle">New Habit</div>
                                    <div class="event-frequency" id="previewEventFrequency">Daily</div>
                                </div>
                            </div>
                            <div class="calendar-preview-note">
                                <span class="preview-note-icon">💡</span>
                                <span class="preview-note-text">These events will be automatically added to your calendar based on your frequency settings.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveHabit()" id="saveBtn" disabled>Create Habit</button>
            </div>
        </div>
    </div>

    <script>
        let selectedIcon = '🎯';
        let selectedColor = 'linear-gradient(135deg, #FF7101, #FF5722)';
        let selectedMeasurementType = 'simple';
        let selectedFrequency = 'daily';
        let selectedDays = [];
        let goalLinkEnabled = true;
        let calendarIntegrationEnabled = true;

        function toggleIconGrid() {
            const iconGrid = document.getElementById('iconGrid');
            iconGrid.style.display = iconGrid.style.display === 'none' ? 'grid' : 'none';
        }

        function selectIcon(element, icon) {
            // Remove previous selection
            document.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selection to clicked element
            element.classList.add('selected');
            selectedIcon = icon;
            
            // Update main icon display
            document.getElementById('selectedIcon').textContent = icon;
            document.getElementById('selectedIcon').classList.add('selected');
            
            // Hide icon grid
            document.getElementById('iconGrid').style.display = 'none';
        }

        function selectColor(element) {
            // Remove previous selection
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selection to clicked element
            element.classList.add('selected');
            selectedColor = element.style.background;
            
            validateForm();
        }

        function selectMeasurementType(element, type) {
            // Remove previous selection
            document.querySelectorAll('.measurement-type').forEach(mType => {
                mType.classList.remove('selected');
            });
            
            // Add selection to clicked element
            element.classList.add('selected');
            selectedMeasurementType = type;
            
            // Show/hide target section and update unit
            const targetSection = document.getElementById('targetSection');
            const targetUnit = document.getElementById('targetUnit');
            const targetInput = document.getElementById('targetInput');
            
            if (type === 'simple') {
                targetSection.classList.remove('active');
                targetInput.required = false;
            } else {
                targetSection.classList.add('active');
                targetInput.required = true;
                
                // Update unit based on measurement type
                switch (type) {
                    case 'count':
                        targetUnit.textContent = 'times';
                        targetInput.placeholder = '10';
                        break;
                    case 'time':
                        targetUnit.textContent = 'minutes';
                        targetInput.placeholder = '30';
                        break;
                    case 'custom':
                        targetUnit.textContent = 'units';
                        targetInput.placeholder = '5';
                        break;
                }
            }
            
            validateForm();
        }

        function selectFrequency(element, frequency) {
            // Remove previous selection
            document.querySelectorAll('.frequency-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selection to clicked element
            element.classList.add('selected');
            selectedFrequency = frequency;
            
            // Show/hide frequency-specific sections
            const weeklyDays = document.getElementById('weeklyDays');
            const customFrequency = document.getElementById('customFrequency');
            
            weeklyDays.classList.remove('active');
            customFrequency.classList.remove('active');
            
            if (frequency === 'weekly') {
                weeklyDays.classList.add('active');
            } else if (frequency === 'custom') {
                customFrequency.classList.add('active');
            }
            
            validateForm();
        }

        function toggleDay(element) {
            const day = element.dataset.day;
            
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedDays = selectedDays.filter(d => d !== day);
            } else {
                element.classList.add('selected');
                selectedDays.push(day);
            }
            
            validateForm();
        }

        function toggleGoalLink(element) {
            element.classList.toggle('active');
            goalLinkEnabled = element.classList.contains('active');
            
            const goalSelect = document.getElementById('goalSelect');
            goalSelect.disabled = !goalLinkEnabled;
            goalSelect.style.opacity = goalLinkEnabled ? '1' : '0.5';
        }

        function toggleScheduling(element) {
            element.classList.toggle('expanded');
            const content = document.getElementById('schedulingContent');
            content.classList.toggle('expanded');
            
            // Update calendar preview when scheduling section is opened
            if (content.classList.contains('expanded')) {
                updateCalendarPreview();
            }
        }

        function toggleCalendarIntegration(element) {
            element.classList.toggle('active');
            calendarIntegrationEnabled = element.classList.contains('active');
            
            // Update preview visibility
            const calendarPreview = document.getElementById('calendarPreview');
            calendarPreview.style.display = calendarIntegrationEnabled ? 'block' : 'none';
        }

        function handleDurationChange() {
            // Duration functionality removed - simplified scheduling
            updateCalendarPreview();
        }

        function updateCalendarPreview() {
            const nameInput = document.querySelector('input[placeholder="What habit do you want to build?"]');
            const timeInput = document.getElementById('habitTime');
            
            const previewTitle = document.getElementById('previewEventTitle');
            const previewFrequency = document.getElementById('previewEventFrequency');
            const eventTime = document.querySelector('.event-time');
            
            // Update event title
            previewTitle.textContent = nameInput.value.trim() || 'New Habit';
            
            // Update frequency display
            let frequencyText = '';
            if (selectedFrequency === 'daily') {
                frequencyText = 'Daily';
            } else if (selectedFrequency === 'weekly') {
                if (selectedDays.length > 0) {
                    const dayAbbrevs = {
                        'mon': 'M', 'tue': 'T', 'wed': 'W', 'thu': 'T', 
                        'fri': 'F', 'sat': 'S', 'sun': 'S'
                    };
                    frequencyText = selectedDays.map(day => dayAbbrevs[day]).join(', ');
                } else {
                    frequencyText = 'Select days';
                }
            } else if (selectedFrequency === 'custom') {
                const customInput = document.getElementById('customInput');
                const customSelect = document.getElementById('customSelect');
                if (customInput.value) {
                    frequencyText = `${customInput.value} times per ${customSelect.value}`;
                } else {
                    frequencyText = 'Custom frequency';
                }
            }
            previewFrequency.textContent = frequencyText;
            
            // Update time display (simplified - just show the scheduled time)
            const startTime = timeInput.value || '09:00';
            eventTime.textContent = formatTime(startTime);
        }

        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function formatTime(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function setDifficulty(level) {
            // Difficulty functionality removed - simplified interface
        }

        function validateForm() {
            const nameInput = document.querySelector('input[placeholder="What habit do you want to build?"]');
            const targetInput = document.getElementById('targetInput');
            const customInput = document.getElementById('customInput');
            const saveBtn = document.getElementById('saveBtn');
            
            let isValid = true;
            
            // Check name
            if (!nameInput.value.trim()) {
                isValid = false;
            }
            
            // Check target amount for non-simple measurement types
            if (selectedMeasurementType !== 'simple' && (!targetInput.value || targetInput.value < 1)) {
                isValid = false;
            }
            
            // Check weekly frequency has at least one day selected
            if (selectedFrequency === 'weekly' && selectedDays.length === 0) {
                isValid = false;
            }
            
            // Check custom frequency has valid input
            if (selectedFrequency === 'custom' && (!customInput.value || customInput.value < 1)) {
                isValid = false;
            }
            
            saveBtn.disabled = !isValid;
        }

        function collectHabitData() {
            const nameInput = document.querySelector('input[placeholder="What habit do you want to build?"]');
            const descriptionTextarea = document.querySelector('textarea[placeholder*="important"]');
            const targetInput = document.getElementById('targetInput');
            const customInput = document.getElementById('customInput');
            const customSelect = document.getElementById('customSelect');
            const goalSelect = document.getElementById('goalSelect');
            const startDateInput = document.getElementById('startDate');
            const reminderTimeInput = document.getElementById('reminderTime');
            const categorySelect = document.querySelector('select[class="advanced-input"]');
            
            const habitData = {
                name: nameInput.value.trim(),
                description: descriptionTextarea.value.trim() || null,
                icon: selectedIcon,
                color: selectedColor,
                measurementType: selectedMeasurementType,
                frequency: selectedFrequency,
                goalId: goalLinkEnabled ? goalSelect.value || null : null,
                difficultyLevel: difficultyLevel,
                createdAt: new Date().toISOString()
            };
            
            // Add target amount for non-simple measurement types
            if (selectedMeasurementType !== 'simple') {
                habitData.targetAmount = parseInt(targetInput.value);
                habitData.targetUnit = document.getElementById('targetUnit').textContent;
            }
            
            // Add frequency-specific data
            if (selectedFrequency === 'weekly') {
                habitData.selectedDays = selectedDays;
            } else if (selectedFrequency === 'custom') {
                habitData.customFrequency = {
                    times: parseInt(customInput.value),
                    period: customSelect.value
                };
            }
            
            // Add advanced options
            if (startDateInput.value) {
                habitData.startDate = startDateInput.value;
            }
            
            if (reminderTimeInput.value) {
                habitData.reminderTime = reminderTimeInput.value;
            }
            
            if (categorySelect.value) {
                habitData.category = categorySelect.value;
            }
            
            return habitData;
        }

        function saveHabit() {
            if (!validateForm()) {
                alert('Please fill in all required fields.');
                return;
            }
            
            const habitData = collectHabitData();
            
            console.log('Saving habit:', habitData);
            
            // Simulate save success
            alert('Habit created successfully!');
            closeModal();
        }

        function closeModal() {
            document.querySelector('.modal-overlay').style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today as default start date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            
            // Add input listeners for validation
            const nameInput = document.querySelector('input[placeholder="What habit do you want to build?"]');
            const targetInput = document.getElementById('targetInput');
            const customInput = document.getElementById('customInput');
            
            nameInput.addEventListener('input', validateForm);
            targetInput.addEventListener('input', validateForm);
            customInput.addEventListener('input', validateForm);
            
            // Initial validation
            validateForm();
        });

        // Prevent modal close when clicking inside modal
        document.querySelector('.modal').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Close modal when clicking overlay
        document.querySelector('.modal-overlay').addEventListener('click', closeModal);

        // Handle escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>